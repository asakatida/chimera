---
jobs:
  clangformat:
    concurrency:
      cancel-in-progress: ${{ github.ref != 'refs/heads/stable' }}
      group: clangformat-${{ github.ref }}
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.1.0
      - name: Lint c++ code
        uses: ./
        with:
          run: >
            CC='' CXX='' CXXFLAGS='' pip install -r requirements.txt | { grep --invert-match -e '^Requirement already satisfied:' || true; };
            python tools/g_ls_tree.py cpp h hpp |
            xargs --no-run-if-empty --
            /usr/local/bin/clang-format --dry-run -style=file -Werror
  clangtidy:
    concurrency:
      cancel-in-progress: ${{ github.ref != 'refs/heads/stable' }}
      group: clangtidy-${{ github.ref }}
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3.1.0
        with:
          submodules: true
      - name: CCache
        uses: actions/cache@v3.0.11
        with:
          key: clang-tidy-${{ hashFiles('CMakeLists.txt') }}-${{ github.run_id }}
          path: .ccache
          restore-keys: |
            clang-tidy-${{ hashFiles('CMakeLists.txt') }}
            build-${{ hashFiles('CMakeLists.txt') }}
            build
      - name: Configure CMake
        uses: ./
        with:
          run: cmake -B build -S .
      - if: ${{ !matrix.lints }}
        name: Lint c++ code
        uses: ./
        with:
          run: >
            CC='' CXX='' CXXFLAGS='' pip install -r requirements.txt | { grep --invert-match -e '^Requirement already satisfied:' || true; };
            python tools/clang_tidy.py build
              bugprone-*,bugprone-use-after-move,-bugprone-easily-swappable-parameters,-bugprone-exception-escape
              cert-*
              clang-*
              concurrency-*
              cppcoreguidelines-*
              hicpp-*,hicpp-invalid-access-moved
              misc-*,misc-const-correctness,-misc-confusable-identifiers,-misc-no-recursion
              misc-confusable-identifiers
              modernize-*
              performance-*
              portability-*
              readability-*,-readability-identifier-length,-readability-static-accessed-through-instance

name: ClangTidy

# yamllint disable-line rule:truthy
on:
  pull_request:
    branches:
      - stable
    paths:
      - .github/workflows/clang-tidy.yml
      - "**.cpp"
      - "**.hpp"
      - "**.h"
      - .clang-format
      - .clang-tidy
      - CMakeLists.txt
  push:
    branches:
      - stable
    paths:
      - .github/workflows/clang-tidy.yml
      - "**.cpp"
      - "**.hpp"
      - "**.h"
      - .clang-format
      - .clang-tidy
      - CMakeLists.txt
  workflow_dispatch: ~
